# Prerequisites #
In order to debug q4e, you'll need to get the sources and set up your environment.
This is described in WorkingWithSources.

# Enabling traces #

Q4e plug-ins can generate traces to standard out when the traces are enabled.

This document describes how to enable tracing for q4e, what kind of traces will generate each supported trace option and how to implement traces in other plug-ins.

For a general introduction to tracing in eclipse, you can refer to the [eclipse help](http://help.eclipse.org/help33/index.jsp?topic=/org.eclipse.pde.doc.user/guide/tools/launchers/tracing.htm) or this [blog entry](http://ramblingabout.wordpress.com/2007/10/20/tracing-plug-ins-in-eclipse/).

You can use [this thread on the developers' group](http://groups.google.com/group/q4e-dev/browse_thread/thread/eb0a9aa5368ef8df) for general discussion on this page.

# Usage #

## I'm a plug-in user ##

If you're using q4e and experiencing problems (or just curious about the inner workings of q4e), you can obtain extra information by enabling traces in your Eclipse Workbench.

First, you'll need to pass an additional parameter (`-debug`) to eclipse when launching, indicating the file that Eclipse should use to know which traces are to be enabled:

```
eclipse.exe -debug c:\eclipse\iam.debug
```

More information on this is also [available from Eclipse](http://www.eclipse.org/eclipse/platform-core/documents/3.1/debug.html).

The contents of the `iam.debug` file will look like this:
```
# Debugging options for the Q4E/IAM plugin

# Global trace switch for this plug-in. This option must be enabled if tracing this plug-in is desired.
org.devzuz.q.maven.jdt.core/debug = true

# Trace for events related to the resource listener.
org.devzuz.q.maven.jdt.core/debug/jdtResourceListener = true

# Trace for events related to classpath updates.
org.devzuz.q.maven.jdt.core/debug/classpathUpdate = true

#  This switch enables/disables time information in every other trace.
org.devzuz.q.maven.jdt.core/debug/timing = true
```

This format is similar to the `.options` files described below. You can use the _Traceable plug-ins in q4e_ section for a reference of which traces can be specified.

## I'm a plug-in developer ##

If you are a plug-in developer, you would probably prefer to be able to enable traces in a more dynamic way through the run-time workbench launch configurations.

To enable tracing for this scenario, two changes are needed in the launch configuration:

  1. Add the `-debug` flag the program arguments. This is the master switch for enabling traces.
    * ![http://q4e.googlecode.com/svn/wiki/img/trace/trace-commandline.png](http://q4e.googlecode.com/svn/wiki/img/trace/trace-commandline.png)
  1. Select the desired tracing options in the _Tracing_ tab.
    * ![http://q4e.googlecode.com/svn/wiki/img/trace/trace-options.png](http://q4e.googlecode.com/svn/wiki/img/trace/trace-options.png)

Once the trace options are selected and the run-time workbench has been launched, trace messages can be seen in the console of the launcher eclipse.

![http://q4e.googlecode.com/svn/wiki/img/trace/trace-console.png](http://q4e.googlecode.com/svn/wiki/img/trace/trace-console.png)

## Traceable plug-ins in q4e ##

This is the list of plug-ins which support generating traces and the description of the available trace options.

| This list was autogenerated from q4e sources with the following script |
|:-----------------------------------------------------------------------|
| `for file in `find . -name .options`; do echo === `dirname $file` === ; echo {{{; cat $file; echo ; echo }}} ; echo; done` |

### ./maven/core ###
```
# Global trace switch for this plug-in
org.devzuz.q.maven.core/debug=false
# Trace for events related to the eclipse artifact resolver
org.devzuz.q.maven.core/debug/artifact-resolver=false
# Trace for events related to the maven project manager cache
org.devzuz.q.maven.core/debug/project-cache=false
# Trace for events related to the property tester
org.devzuz.q.maven.core/debug/property-tester=false
# This switch enables/disables time information in every other trace 
org.devzuz.q.maven.core/debug/timing=false
```

### ./maven/jdt/core ###
```
# Global trace switch for this plug-in
org.devzuz.q.maven.jdt.core/debug=false
# Trace for events related to the resource listener
org.devzuz.q.maven.jdt.core/debug/jdtResourceListener=false
# Trace for events related to classpath updates
org.devzuz.q.maven.jdt.core/debug/classpathUpdate=false
# Trace for events related to the maven incremental builder
org.devzuz.q.maven.jdt.core/debug/mavenBuilder=false
# This switch enables/disables time information in every other trace 
org.devzuz.q.maven.jdt.core/debug/timing=false
```

### ./maven/jdt/ui ###
```
# Global trace switch for this plug-in
org.devzuz.q.maven.jdt.ui/debug=false
# Trace for events related to importing projects
org.devzuz.q.maven.jdt.ui/debug/import=false
# Trace for events related to scanning for projects
org.devzuz.q.maven.jdt.ui/debug/scanning=false
# Trace for events related to enabling Maven management of dependencies for projects
org.devzuz.q.maven.jdt.ui/debug/enable=false
# This switch enables/disables time information in every other trace 
org.devzuz.q.maven.jdt.ui/debug/timing=false
```

### ./maven/wtp/core ###
```
# Global trace switch for this plug-in
org.devzuz.q.maven.wtp.core/debug=false
# Trace for events related to assigning classpath attributes
# to classpath container and individual entries.
org.devzuz.q.maven.wtp.core/debug/classpathAttributeProvider=false
# Trace for events related to postprocessing projects
org.devzuz.q.maven.wtp.core/debug/postprocessor=false
# This switch enables/disables time information in every trace 
org.devzuz.q.maven.wtp.core/debug/timing=false
```

# Implementation #

This section tries to set the _standard_ way in **q4e** for adding new trace options in to a plug-in, or how to implement tracing in a plug-in that does not support tracing yet.

For reference, check the implementation in `org.devzuz.q.maven.jdt.core`:
  * The [MavenJdtCoreActivator](http://q4e.googlecode.com/svn/trunk/plugins/maven/jdt/core/src/main/java/org/devzuz/q/maven/jdt/core/MavenJdtCoreActivator.java)'s trace method.
  * The [TraceOption](http://q4e.googlecode.com/svn/trunk/plugins/maven/jdt/core/src/main/java/org/devzuz/q/maven/jdt/core/internal/TraceOption.java) enum.

## TraceOption ##
Because there are only so many trace options, it makes sense to use an enumeration class to manage them.

Each of the enumeration values will have a property for accessing the trace option (as a `String`) that it represents. This option must have the format:

`PLUGIN_ID/debug/myTraceOption`

For example: `org.devzuz.q.maven.jdt.core/debug/classpathUpdate` (you probably remember the format from the previous sections).

So the code looks like:

```
public enum TraceOption
{
    JDT_RESOURCE_LISTENER( "/jdtResourceListener" ), CLASSPATH_UPDATE( "/classpathUpdate" );

    private final String value;

    TraceOption( String value )
    {
        this.value = Activator.PLUGIN_GLOBAL_TRACE_OPTION + value;
    }

    /**
     * Obtains the string value of the trace option, including the plug-in ID and global debug prefix.
     * 
     * For example: <code>org.devzuz.q.maven.jdt.core/debug/classpathUpdate</code>
     * 
     * @return the string value of the trace option.
     */
    public String getValue()
    {
        return value;
    }

}
```

In this code, `Activator.PLUGIN_GLOBAL_TRACE_OPTION` is defined as the plugin id followed by the `/debug` string. As described earlier, this is (by convention) the global trace switch.

If you need a new trace option, just create a new value in the enumeration, and add the default value to the `.options` file.

Now let's see how tracing is done.

## trace() method ##

The method is defined as:

```
/**
     * Sends trace messages to stdout if the specified trace option is enabled.
     * 
     * This is intended only for developing and debugging. The use of variable number of parameters avoids the cost of
     * building the message when the debug option is not enabled.
     * 
     * @param traceOption
     *            the trace option enabling the message trace.
     * @param messageParts
     *            a variable number of objects with each part of the message to display.
     */
    public static void trace( TraceOption traceOption, Object... messageParts )
    {
      // implementation
    }
```

As explained in the javadoc, `trace` signature uses the vararg feature in java 5. This allows callers to avoid building a `String` to call this method, which will reduce the performance impact of tracing.

A client will typically call this method as:

```
  Activator.trace(TraceOption.MY_OPTION, "The object ", myObject, " has been traced!");
```

Inside `trace`, some checks must be performed to meet tracing conventions:
  * Check if the running platform is in debug mode.
  * Check if the global flag for the plug-in is enabled.

This is done with the following code:

```
        if ( !Platform.inDebugMode() )
        {
            return;
        }
        String globalTraceValue = Platform.getDebugOption( PLUGIN_GLOBAL_TRACE_OPTION );
        if ( null == globalTraceValue || !globalTraceValue.equals( "true" ) )
        {
            return;
        }
```

Checking if the platform is in debug mode is straightforward. For checking the value of the global flag, we must first check that it has a value and then if the value is the string `true` (Eclipse automatically passes that value when checking the trace option in the launch configuration).

Now we check if the specific trace option is enabled. Code is similar to checking the global option.

```
        String value = Platform.getDebugOption( traceOption.getValue() );
        if ( null != value && value.equals( "true" ) )
        {
           // Everything OK, let's trace!
        }
```

Tracing is as simple as `println`. Since we have used varargs, we can exploit that to output the parameters without creating a `String`.

```
            System.out.print( "[" );
            System.out.print( traceOption );
            System.out.print( "] " );
            for ( int i = 0; i < messageParts.length; i++ )
            {
                System.out.print( messageParts[i] );
            }
            System.out.println();
```

### Timing ###

Trace options can also be used inside the `trace` method to enable additional details to the printed trace when requested.

For example, we can have a trace option for adding a timestamp to every trace:

```
            String timingValue = Platform.getDebugOption( PLUGIN_GLOBAL_TRACE_OPTION + "/timing" );
            if ( null != timingValue && timingValue.equals( "true" ) )
            {
                if ( null == TIME_FORMAT )
                {
                    TIME_FORMAT = new SimpleDateFormat( "HH:mm:ss.SSS  " );
                }
                System.out.print( TIME_FORMAT.format( new Date() ) );
            }
```

In this case, we've chosen to **not** have a `TraceOption` value for timing, since it can not be directly used.

Being extremely conservative, we do a lazy initialization of the `TIME_FORMAT` field, so it is not created when timing information is not requested.